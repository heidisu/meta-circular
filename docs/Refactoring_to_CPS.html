<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>8&nbsp;Refactoring to CPS</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Make your own meta-<wbr></wbr>circular evaluator!</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="Meta-circular_what_.html" class="tocviewlink" data-pltdoc="x">Meta-<wbr></wbr>circular what?</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Some_Racket.html" class="tocviewlink" data-pltdoc="x">Some Racket</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="Fixing_the_calculator.html" class="tocviewlink" data-pltdoc="x">Fixing the calculator</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="Lookup_in_the_environment.html" class="tocviewlink" data-pltdoc="x">Lookup in the environment</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Definitions.html" class="tocviewlink" data-pltdoc="x">Definitions</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="Functions.html" class="tocviewlink" data-pltdoc="x">Functions</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="Continuation-passing_style.html" class="tocviewlink" data-pltdoc="x">Continuation-<wbr></wbr>passing style</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Refactoring to CPS</a></td></tr><tr><td align="right">9&nbsp;</td><td><a href="Booleans.html" class="tocviewlink" data-pltdoc="x">Booleans</a></td></tr><tr><td align="right">10&nbsp;</td><td><a href="Ambiguousness.html" class="tocviewlink" data-pltdoc="x">Ambiguousness</a></td></tr><tr><td align="right">11&nbsp;</td><td><a href="It_s_puzzle_time.html" class="tocviewlink" data-pltdoc="x">It&rsquo;s puzzle time</a></td></tr><tr><td align="right">12&nbsp;</td><td><a href="Towards_zebras.html" class="tocviewlink" data-pltdoc="x">Towards zebras</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>8&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Refactoring to CPS</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">8.1&nbsp;</td><td><a href="#%28part._.Some_stuff_will_have_a_continue-parameter%29" class="tocviewlink" data-pltdoc="x">Some stuff will have a <span class="RktSym">continue</span>-<wbr></wbr>parameter</a></td></tr><tr><td align="right">8.2&nbsp;</td><td><a href="#%28part._.So_that_did_nothing%29" class="tocviewlink" data-pltdoc="x">So that did nothing</a></td></tr><tr><td align="right">8.3&nbsp;</td><td><a href="#%28part._.Couple_of_tips__maybe%29" class="tocviewlink" data-pltdoc="x">Couple of tips, maybe</a></td></tr><tr><td align="right">8.4&nbsp;</td><td><a href="#%28part._cps-done%29" class="tocviewlink" data-pltdoc="x">Done?</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">8.1<tt>&nbsp;</tt></span><a href="#%28part._.Some_stuff_will_have_a_continue-parameter%29" class="tocsubseclink" data-pltdoc="x">Some stuff will have a <span class="RktSym">continue</span>-<wbr></wbr>parameter</a></td></tr><tr><td><span class="tocsublinknumber">8.1.1<tt>&nbsp;</tt></span><a href="#%28part.__eval-exp_env_continue_exp_%29" class="tocsubseclink" data-pltdoc="x"><span class="RktPn">(</span><span class="RktSym">eval-<wbr></wbr>exp</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">exp</span><span class="RktPn">)</span></a></td></tr><tr><td><span class="tocsublinknumber">8.1.2<tt>&nbsp;</tt></span><a href="#%28part.__eval-sequence_env_continue_exps_%29" class="tocsubseclink" data-pltdoc="x"><span class="RktPn">(</span><span class="RktSym">eval-<wbr></wbr>sequence</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">exps</span><span class="RktPn">)</span></a></td></tr><tr><td><span class="tocsublinknumber">8.1.3<tt>&nbsp;</tt></span><a href="#%28part.__eval-application_env_continue_fun_args_%29" class="tocsubseclink" data-pltdoc="x"><span class="RktPn">(</span><span class="RktSym">eval-<wbr></wbr>application</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">fun</span><span class="stt"> </span><span class="RktSym">args</span><span class="RktPn">)</span></a></td></tr><tr><td><span class="tocsublinknumber">8.1.4<tt>&nbsp;</tt></span><a href="#%28part._.Our__primitives_%29" class="tocsubseclink" data-pltdoc="x">Our &ldquo;primitives&rdquo;</a></td></tr><tr><td><span class="tocsublinknumber">8.1.5<tt>&nbsp;</tt></span><a href="#%28part.__make-function_env_parameters_body_%29" class="tocsubseclink" data-pltdoc="x"><span class="RktPn">(</span><span class="RktSym">make-<wbr></wbr>function</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">parameters</span><span class="stt"> </span><span class="RktSym">body</span><span class="RktPn">)</span></a></td></tr><tr><td><span class="tocsublinknumber">8.1.6<tt>&nbsp;</tt></span><a href="#%28part.__evaluate_input_%29" class="tocsubseclink" data-pltdoc="x"><span class="RktPn">(</span><span class="RktSym">evaluate</span><span class="stt"> </span><span class="RktSym">input</span><span class="RktPn">)</span></a></td></tr><tr><td><span class="tocsublinknumber">8.2<tt>&nbsp;</tt></span><a href="#%28part._.So_that_did_nothing%29" class="tocsubseclink" data-pltdoc="x">So that did nothing</a></td></tr><tr><td><span class="tocsublinknumber">8.3<tt>&nbsp;</tt></span><a href="#%28part._.Couple_of_tips__maybe%29" class="tocsubseclink" data-pltdoc="x">Couple of tips, maybe</a></td></tr><tr><td><span class="tocsublinknumber">8.4<tt>&nbsp;</tt></span><a href="#%28part._cps-done%29" class="tocsubseclink" data-pltdoc="x">Done?</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">7.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="Continuation-passing_style.html" title="backward to &quot;7 Continuation-passing style&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Make your own meta-circular evaluator!&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Booleans.html" title="forward to &quot;9 Booleans&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3>8<tt>&nbsp;</tt><a name="(part._.Refactoring_to_.C.P.S)"></a>Refactoring to CPS</h3><p>If we&rsquo;ve been through the previous part, we can keep using the same file. Or we can use <span class="stt">4-functions.rkt</span> as our starting point.</p><p><div class="SIntrapara">CPS, besides being weird, is kind of neat.
If you&rsquo;re implementing a function,
and the &ldquo;continuation&rdquo; &#8212;<wbr></wbr>everything that is to happen after&#8212;<wbr></wbr> is made available to you as a function,
then, uh, that&rsquo;s a thing you&rsquo;re in control of.</div><div class="SIntrapara">You can decide not to invoke the continuation.
Or you can try to invoke the continuation several times, with different values.
Later on we want to use an <span class="RktSym">amb</span>-form for expressions that can have multiple possible values:
We want to &ldquo;continue&rdquo; with some value, and if that turns out to be no good, we want to try some other value instead.
CPS seems like a good fit.</div></p><h4>8.1<tt>&nbsp;</tt><a name="(part._.Some_stuff_will_have_a_continue-parameter)"></a>Some stuff will have a <span class="RktSym">continue</span>-parameter</h4><p>We will rewrite a few functions so they have a <span class="RktSym">continue</span>-parameter,
and so that, instead of returning a result, they apply <span class="RktSym">continue</span> to a result.
We will put <span class="RktSym">continue</span> just after <span class="RktSym">env</span> in the parameter lists.
E.g. <span class="RktSym">eval-application</span> will go like <span class="RktPn">(</span><span class="RktSym">eval-application</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">fun</span><span class="stt"> </span><span class="RktSym">args</span><span class="RktPn">)</span>.</p><h5>8.1.1<tt>&nbsp;</tt><a name="(part.__eval-exp_env_continue_exp_)"></a><span class="RktPn">(</span><span class="RktSym">eval-exp</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">exp</span><span class="RktPn">)</span></h5><p><span class="RktSym">eval-exp</span> isn&rsquo;t too bad. In most of the <span class="RktSym">match</span>-clauses we return a value pretty directly.
In those cases we will pass the values along to <span class="RktSym">continue</span> instead.
In the case where we call <span class="RktSym">eval-application</span>, we will pass our <span class="RktSym">continue</span> along to <span class="RktSym">eval-application</span> and put it in after <span class="RktSym">env</span> parameter. The same goes for <span class="RktSym">eval-sequence</span>.</p><h5>8.1.2<tt>&nbsp;</tt><a name="(part.__eval-sequence_env_continue_exps_)"></a><span class="RktPn">(</span><span class="RktSym">eval-sequence</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">exps</span><span class="RktPn">)</span></h5><p>The cases where we have some <span class="RktSym">rest</span>-expressions are a little trickier.
In, say, the <span class="RktVal">'</span><span class="RktVal">define</span>-case, we must make a continuation-function to use with <span class="RktSym">eval-exp</span>. Like:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">eval-exp</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">&#955;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">value</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-style: italic">your code here</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">exp</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Within this continuation-function, we will do the stuff we previously did <span style="font-style: italic">after</span> the call to <span class="RktSym">eval-exp</span>:
Extend the environment and call <span class="RktSym">eval-sequence</span> again. We will pass our &ldquo;original&rdquo; <span class="RktSym">continue</span> to <span class="RktSym">eval-sequence</span>.</p><h5>8.1.3<tt>&nbsp;</tt><a name="(part.__eval-application_env_continue_fun_args_)"></a><span class="RktPn">(</span><span class="RktSym">eval-application</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">continue</span><span class="stt"> </span><span class="RktSym">fun</span><span class="stt"> </span><span class="RktSym">args</span><span class="RktPn">)</span></h5><p><div class="SIntrapara">Maybe the trickiest. We must evaluate the <span class="RktSym">fun</span>-expression with <span class="RktSym">eval-exp</span>, with a continuation that deals with the arguments.
For every argument in the list, there will be a call to <span class="RktSym">eval-exp</span> with a continuation that deals with
the rest of the arguments and performing the function application. Along the way we must keep track of the arguments we have evaluated.
Finally, the function we are going to apply will take a <span class="RktSym">continue</span>-argument before the evaluated <span class="RktSym">args</span>:
We will pass our <span class="RktSym">continue</span>-parameter along to it.</div><div class="SIntrapara">It is likely that evaluating the arguments is the hardest bit. We probably want this:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">eval-arguments</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktSym">args</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">match</span><span class="hspace">&nbsp;</span><span class="RktSym">args</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span style="font-style: italic">your code here</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">list</span><span class="hspace">&nbsp;</span><span class="RktSym">arg</span><span class="hspace">&nbsp;</span><span class="RktSym">rest</span><span class="hspace">&nbsp;</span><span class="RktSym">...</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span style="font-style: italic">your code here</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara">In <span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">)</span>-case: Evaluating all the arguments in the empty list is maybe not <span style="font-style: italic">too</span> hard?</div><div class="SIntrapara">In the <span class="RktPn">(</span><span class="RktSym">list</span><span class="stt"> </span><span class="RktSym">arg</span><span class="stt"> </span><span class="RktSym">rest</span><span class="stt"> </span><span class="RktSym">...</span><span class="RktPn">)</span>-case:
We want to <span class="RktSym">eval-exp</span> the <span class="RktSym">arg</span>,
then <span class="RktSym">eval-arguments</span> the <span class="RktSym">rest</span> of the arguments,
and then <span class="RktSym">cons</span> the evaluated argument onto the evaluated rest-of-the-arguments.
Like, we&rsquo;re really &ldquo;just&rdquo; trying to map <span class="RktSym">eval-exp</span> over <span class="RktSym">args</span>. Having to work out what needs to go in which continuation makes things more confusing though.</div></p><h5>8.1.4<tt>&nbsp;</tt><a name="(part._.Our__primitives_)"></a>Our &ldquo;primitives&rdquo;</h5><p>Instead of e.g. the <span class="RktSym">+</span>-function we want a function that has a <span class="RktSym">continue</span>-argument first:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">my-plus</span><span class="hspace">&nbsp;</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">. </span><span class="RktSym">args</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span style="font-style: italic">your code here</span><span class="RktPn">)</span></td></tr></table></blockquote><p>When this function is applied, all the arguments after the <span class="RktSym">continue</span> are collected in  <span class="RktSym">args</span>, as a list.
We can use the <span class="RktSym">apply</span>-function to apply the original <span class="RktSym">+</span>-function to the <span class="RktSym">args</span>.
(And we want to apply <span class="RktSym">continue</span> to the result rather than just returning it.)</p><p><div class="SIntrapara">It is pretty possible, while not exactly necessary, to make a helper-function for this.
One that takes a regular function as its argument and returns a more CPS-compliant function.
Something along the lines of</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">primitive</span><span class="hspace">&nbsp;</span><span class="RktSym">function</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">&#955;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">continue</span><span class="hspace">&nbsp;</span><span class="RktPn">. </span><span class="RktSym">args</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-style: italic">your code here</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>could be convenient.</p><h5>8.1.5<tt>&nbsp;</tt><a name="(part.__make-function_env_parameters_body_)"></a><span class="RktPn">(</span><span class="RktSym">make-function</span><span class="stt"> </span><span class="RktSym">env</span><span class="stt"> </span><span class="RktSym">parameters</span><span class="stt"> </span><span class="RktSym">body</span><span class="RktPn">)</span></h5><p>We&rsquo;re not adding a <span class="RktSym">continue</span>-parameter to <span class="RktSym">make-function</span> function,
but we need to add it to the function returned by <span class="RktSym">make-function</span>.
That <span class="RktSym">continue</span> should be passed in as the second argument to <span class="RktSym">eval-sequence</span>.</p><h5>8.1.6<tt>&nbsp;</tt><a name="(part.__evaluate_input_)"></a><span class="RktPn">(</span><span class="RktSym">evaluate</span><span class="stt"> </span><span class="RktSym">input</span><span class="RktPn">)</span></h5><p>For now, we want <span class="RktSym">evaluate</span> to work the same way as before, so we are not adding a <span class="RktSym">continue</span>-parameter to it.
But it does use <span class="RktSym">eval-exp</span> so we need to add a <span class="RktSym">continue</span>-argument there.
We will use Racket&rsquo;s <span class="RktSym">identity</span>-function.</p><h4>8.2<tt>&nbsp;</tt><a name="(part._.So_that_did_nothing)"></a>So that did nothing</h4><p>So, if we got things right then we have kind of made no changes.
Under the hood things work differently,
but there are no new features and all the expressions in the language we&rsquo;re making should <span class="RktSym">evaluate</span> to the same values.</p><p>How dull? On the plus side we didn&rsquo;t have to write any new tests...</p><h4>8.3<tt>&nbsp;</tt><a name="(part._.Couple_of_tips__maybe)"></a>Couple of tips, maybe</h4><p><div class="SIntrapara">Okay so this stuff is like not straightforward.
Because CPS.
Also because we have to change a bunch of of interdependent functions: We change one and everything breaks.
So. Two tips:</div><div class="SIntrapara">One tip:
Use Racket&rsquo;s <span class="RktSym">identity</span>-function for stuff.
If you pass <span class="RktSym">identity</span> in as the <span class="RktSym">continue</span>-argument to a function, then <span class="RktSym">identity</span> should just return the result we&rsquo;re intersted in.</div><div class="SIntrapara">Another tip:
Maybe change <span class="RktSym">eval-exp</span> so that it handles the simplest expression, the literals, correctly first, and let everything else break.
Then, when rewriting each &ldquo;feature&rdquo; to CPS, we can test them with expressions where all the subexpressions are just literals.
E.g. when working on <span class="RktSym">eval-arguments</span>, just use a list of numbers for the <span class="RktSym">args</span> to begin with.</div></p><h4>8.4<tt>&nbsp;</tt><a name="(part._cps-done)"></a>Done?</h4><p><div class="SIntrapara">Run and see that all the tests pass.</div><div class="SIntrapara">Next is <a href="Booleans.html" data-pltdoc="x">Booleans</a>.
We can keep using the Racket-file we&rsquo;re working with, or skip to <span class="stt">5-continuation-passing-style.rkt</span>.</div></p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="Continuation-passing_style.html" title="backward to &quot;7 Continuation-passing style&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Make your own meta-circular evaluator!&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Booleans.html" title="forward to &quot;9 Booleans&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>